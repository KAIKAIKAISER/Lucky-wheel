<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÅöÂÜ≥ÂÆöÂ∞èÂä©Êâã - ‰∫ëÂêåÊ≠•Áâà</title>
    <!-- ÂºïÂÖ•Â•ΩÁúãÁöÑÂ≠ó‰Ωì -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <!-- ÂºïÂÖ• Supabase ÂÆ¢Êà∑Á´ØÂ∫ì -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-gradient: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --sidebar-bg: rgba(255, 255, 255, 0.5);
            --text-main: #2d3436;
            --text-sub: #636e72;
            --accent-color: #ff7675;
            --success-color: #00b894;
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Poppins', 'Noto Sans SC', sans-serif; 
            background-image: var(--bg-gradient);
            height: 100vh; 
            display: flex; 
            color: var(--text-main);
            overflow: hidden;
        }

        /* --- Â∏ÉÂ±ÄÂÆπÂô® --- */
        .app-container { 
            display: flex; 
            width: 100%; 
            height: 100%; 
            backdrop-filter: blur(4px);
        }
        
        /* --- Â∑¶‰æß‰æßËæπÊ†è --- */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            overflow-y: hidden;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar h2 { 
            font-size: 1.1rem; 
            margin-bottom: 20px; 
            padding-left: 8px;
            color: var(--text-main);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .sidebar h2::before { content: '‚ö°'; font-size: 1.2rem; }
        
        .topic-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 4px;
        }

        .topic-list { list-style: none; }
        
        .topic-item {
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: var(--text-sub);
            background: transparent;
            min-height: 50px;
        }
        
        .topic-text {
            flex: 1; margin-right: 10px; word-break: break-word; white-space: normal; line-height: 1.4;
        }
        
        .topic-item:hover { background: rgba(255,255,255, 0.6); }
        .topic-item.active { background: #fff; color: #6c5ce7; font-weight: 600; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.15); }
        
        .btn-delete-topic { 
            font-size: 14px; opacity: 0; padding: 6px 10px; border-radius: 6px; transition: 0.2s; flex-shrink: 0;
        }
        .topic-item:hover .btn-delete-topic { opacity: 0.5; }
        .topic-item.active .btn-delete-topic { opacity: 0.8; }
        .btn-delete-topic:hover { opacity: 1 !important; background: #ffecec; color: #d63031; }

        .btn-add-topic {
            width: 100%; padding: 12px; background: white; border: 2px dashed #b2bec3;
            color: #636e72; cursor: pointer; text-align: center; border-radius: 12px;
            font-weight: 500; transition: 0.3s; flex-shrink: 0; margin-bottom: 15px;
        }
        .btn-add-topic:hover { border-color: #6c5ce7; color: #6c5ce7; background: rgba(255,255,255,0.8); }

        /* ‰∫ëÂêåÊ≠•Âå∫Âüü */
        .cloud-sync-area {
            border-top: 1px solid rgba(255,255,255,0.4);
            padding-top: 15px;
            flex-shrink: 0;
        }
        .sync-input {
            width: 100%; padding: 10px; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.7); margin-bottom: 8px;
            font-size: 12px; color: #2d3436;
        }
        .sync-input:focus { outline: 2px solid #a29bfe; background: white; }
        
        .btn-cloud {
            width: 100%; padding: 10px; border: none; border-radius: 10px;
            color: white; font-size: 13px; cursor: pointer; transition: 0.2s;
            font-weight: 600; background: #00b894;
            display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .btn-cloud:hover { background: #00a884; transform: translateY(-1px); }
        .btn-cloud:disabled { background: #b2bec3; cursor: wait; transform: none; }

        /* --- Âè≥‰æß‰∏ªÂÜÖÂÆπ --- */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; align-items: center;
            padding: 30px; overflow-y: auto; position: relative;
        }

        .input-card {
            background: var(--glass-bg); padding: 20px 30px; border-radius: 20px;
            box-shadow: var(--shadow-soft); width: 100%; max-width: 600px;
            margin-bottom: 30px; text-align: center; border: 1px solid rgba(255,255,255,0.6);
            flex-shrink: 0;
        }

        .header-area input {
            font-family: inherit; font-size: 1.8rem; font-weight: 700; text-align: center;
            border: none; background: transparent; width: 100%; color: #2d3436;
            margin-bottom: 10px; padding: 5px;
        }
        .header-area input::placeholder { color: #b2bec3; font-weight: 400; }
        .header-area input:focus { outline: none; }

        .options-editor textarea {
            width: 100%; height: 60px; padding: 10px; border: none;
            border-bottom: 2px solid #dfe6e9; background: transparent; resize: none;
            font-family: inherit; font-size: 0.95rem; text-align: center; transition: 0.3s; color: #636e72;
        }
        .options-editor textarea:focus { border-bottom-color: #a29bfe; outline: none; background: rgba(255,255,255,0.5); }
        
        .options-footer {
            display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 12px;
        }
        .options-hint { color: #a4b0be; }
        .save-status {
            color: var(--success-color); opacity: 0; transition: opacity 0.3s;
            font-weight: 600; font-size: 12px;
        }
        .save-status.visible { opacity: 1; }

        /* --- ËΩ¨Áõò --- */
        .wheel-wrapper {
            position: relative; padding: 10px; background: white; border-radius: 50%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); flex-shrink: 0;
        }
        .wheel-container { position: relative; width: 380px; height: 380px; }
        canvas { width: 100%; height: 100%; display: block; border-radius: 50%; transition: transform 4s cubic-bezier(0.15, 0.9, 0.30, 1); }

        .pointer {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; z-index: 20; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
        }
        .pointer::after {
            content: ''; position: absolute; left: 0; top: 0; width: 40px; height: 40px;
            background: var(--accent-color); border-radius: 50% 50% 0; transform: rotate(-45deg); border: 3px solid white;
        }
        
        .spin-btn {
            margin-top: 35px; padding: 16px 60px; font-size: 1.2rem; font-weight: 700;
            background: var(--primary-gradient); color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 25px rgba(118, 75, 162, 0.4);
            transition: all 0.3s; position: relative; overflow: hidden; letter-spacing: 1px; flex-shrink: 0;
        }
        .spin-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(118, 75, 162, 0.5); }
        .spin-btn:active { transform: scale(0.95); }
        .spin-btn:disabled { background: #b2bec3; cursor: not-allowed; transform: none; box-shadow: none; }

        .result-container {
            margin-top: 20px; min-height: 80px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; padding-bottom: 20px;
        }
        .result-text {
            font-size: 1.8rem; font-weight: 700; color: #2d3436; opacity: 0; transform: translateY(10px); transition: all 0.5s;
        }
        .result-text.show { opacity: 1; transform: translateY(0); }

        .warning-msg {
            background: #ff7675; color: white; font-size: 0.85rem; margin-top: 10px;
            padding: 6px 16px; border-radius: 20px; box-shadow: 0 4px 10px rgba(255, 118, 117, 0.4);
            display: none; animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* --- ÁßªÂä®Á´ØÈÄÇÈÖç --- */
        @media (max-width: 768px) {
            body { flex-direction: column; } .app-container { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; padding: 10px; flex-direction: row; 
                overflow-x: auto; overflow-y: hidden; background: rgba(255,255,255,0.95);
                border-right: none; border-bottom: 1px solid #eee; align-items: center; scrollbar-width: none; 
            }
            .sidebar::-webkit-scrollbar { display: none; } 
            .sidebar h2 { display: none; }
            
            /* ÁßªÂä®Á´ØÂ∞Ü‰∫ëÂêåÊ≠•ÈöêËóèÂú®‰æßËæπÊàñËÄÖÁº©Â∞èÔºåËøôÈáå‰∏∫‰∫ÜÂ∏ÉÂ±ÄÊï¥Ê¥ÅÔºåÊàë‰ª¨Êää‰∫ëÂêåÊ≠•ÊîæÂú®ÊúÄÂè≥‰æß */
            .cloud-sync-area {
                padding-top: 0; border: none; margin-left: auto; display: flex; gap: 5px; align-items: center;
            }
            .sync-input { width: 100px; margin-bottom: 0; padding: 6px; }
            .btn-cloud { width: auto; padding: 6px 10px; font-size: 12px; white-space: nowrap; }
            .btn-cloud span { display: none; } /* ÊâãÊú∫Á´ØÂè™ÊòæÁ§∫ÂõæÊ†á */

            .topic-list-container { display: flex; flex-direction: row; margin-bottom: 0; padding-right: 0; flex-grow: 1; }
            .topic-list { display: flex; flex-direction: row; gap: 10px; }
            .topic-item { margin-bottom: 0; padding: 6px 16px; font-size: 13px; border-radius: 20px; background: #f1f2f6; border: 1px solid transparent; min-height: auto; }
            .topic-text { white-space: nowrap; margin-right: 6px; }
            .topic-item.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
            
            .btn-add-topic { 
                margin-bottom: 0; margin-left: 5px; margin-right: 5px; white-space: nowrap; height: 32px; width: 32px;
                padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; border-style: solid;
            }
            .main-content { padding: 15px; } .input-card { padding: 15px; margin-bottom: 15px; }
            .header-area input { font-size: 1.4rem; } .wheel-wrapper { padding: 6px; }
            .wheel-container { width: 280px; height: 280px; } .spin-btn { width: 100%; margin-top: 25px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Â∑¶‰æßÂàóË°® -->
    <div class="sidebar" id="sidebar">
        <h2>ÊàëÁöÑÂÜ≥ÂÆö</h2>
        
        <div class="topic-list-container">
            <ul class="topic-list" id="topicList">
                <!-- JSÁîüÊàêÂàóË°®È°π -->
            </ul>
        </div>

        <div class="btn-add-topic" id="btnAddTopic" title="Ê∑ªÂä†Êñ∞ÂÜ≥ÂÆö">+ Êñ∞Âª∫</div>
        
        <!-- ‰∫ëÂêåÊ≠•ÊéßÂà∂Âå∫ -->
        <div class="cloud-sync-area">
            <input type="text" id="syncKeyInput" class="sync-input" placeholder="ËæìÂÖ•ÂêåÊ≠•ÊöóÂè∑(Â¶Ç: jack88)">
            <button class="btn-cloud" id="btnSync" onclick="startCloudSync()">
                ‚òÅÔ∏è <span>ÂêåÊ≠•</span>
            </button>
        </div>
    </div>

    <!-- Âè≥‰æß‰∏ªÂå∫Âüü -->
    <div class="main-content">
        <div class="input-card">
            <div class="header-area">
                <input type="text" id="topicTitle" placeholder="Ê†áÈ¢òÔºàÂ¶ÇÔºöÂéªÂì™Áé©Ôºâ" autocomplete="off">
            </div>
            <div class="options-editor">
                <textarea id="topicOptions" placeholder="ËæìÂÖ•ÈÄâÈ°πÔºö‰∏äÊµ∑ Á∫ΩÁ∫¶ ‰∏ú‰∫¨ÔºàÁî®Á©∫Ê†ºÊàñÈÄóÂè∑ÂàÜÈöîÔºâ" autocomplete="off"></textarea>
                <div class="options-footer">
                    <span class="options-hint">ÈÄâÈ°πË∂äÂ§öË∂äÂà∫ÊøÄ</span>
                    <span class="save-status" id="saveStatus">‚úì Â∑≤‰øùÂ≠ò</span>
                </div>
            </div>
        </div>

        <div class="wheel-wrapper">
            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="800" height="800"></canvas>
            </div>
        </div>

        <button class="spin-btn" id="spinBtn">ÂºÄÂßãÂÅöÂÜ≥ÂÆö</button>

        <div class="result-container">
            <div class="result-text" id="resultText"></div>
            <div class="warning-msg" id="warningMsg">‚ö†Ô∏è ÂêåÊ†∑ÁöÑÂëΩËøêÂ∑≤ÁªèÈôç‰∏¥‰∏âÊ¨°‰∫ÜÔºÅ</div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ËØ∑Âú®ËøôÈáåÂ°´ÂÖ•‰Ω†ÁöÑ Supabase ÈÖçÁΩÆ‰ø°ÊÅØ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    // ============================================================
    const supabaseConfig = {
        url: 'https://xaniobacfeluxrivonoz.supabase.co',  // ÊõøÊç¢ Project URL
        key: 'sb_publishable_ExJJzJmSAYxw0nTqQNWy3A_eGYjjb5K	'              // ÊõøÊç¢ API Key
    };
    
    // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´Ø
    let supabase = null;
    try {
        if (supabaseConfig.url.includes('‰Ω†ÁöÑÈ°πÁõÆID')) {
            console.warn("ËØ∑Âú®‰ª£Á†Å‰∏≠ÈÖçÁΩÆ Supabase URL Âíå Key ÊâçËÉΩ‰ΩøÁî®‰∫ëÂêåÊ≠•ÂäüËÉΩ");
        } else {
            supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);
        }
    } catch (e) { console.error("Supabase Init Error", e); }

    // --- Êï∞ÊçÆÈÖçÁΩÆ ---
    const defaultTopics = [
        { id: 't1', title: "ÂéªÂì™ÈáåÊóÖÊ∏∏", options: ["‰∏äÊµ∑", "‰∏ú‰∫¨", "Á∫ΩÁ∫¶", "ÊõºË∞∑", "ÈõÖÂä†Ëææ", "ÂêâÈöÜÂù°"] },
        { id: 't2', title: "‰ªäÂ§©ÂêÉ‰ªÄ‰πà", options: ["È∫¶ÂΩìÂä≥", "ÁÅ´ÈîÖ", "Ê≤ôÊãâ", "‰æøÂà©Â∫ó", "‰∏çÂêÉ‰∫Ü", "Êó•Êñô"] },
        { id: 't3', title: "Âë®Êú´Ê¥ªÂä®", options: ["Áù°Ëßâ", "ÊâìÊ∏∏Êàè", "Áúã‰π¶", "Áà¨Â±±", "ÈÄõË°ó"] }
    ];

    const colors = [
        "#FF9FF3", "#FECA57", "#FF6B6B", "#48DBFB", "#1DD1A1",
        "#54a0ff", "#5f27cd", "#ff9f43", "#00d2d3", "#ff6b81"
    ];

    let topics = [];
    let currentTopicId = null;
    let currentRotation = 0; 
    let isSpinning = false;
    let sessionCounts = {}; 

    // DOM ÂÖÉÁ¥†
    const els = {
        sidebar: document.getElementById('sidebar'),
        topicList: document.getElementById('topicList'),
        btnAddTopic: document.getElementById('btnAddTopic'),
        topicTitle: document.getElementById('topicTitle'),
        topicOptions: document.getElementById('topicOptions'),
        saveStatus: document.getElementById('saveStatus'),
        canvas: document.getElementById('wheelCanvas'),
        spinBtn: document.getElementById('spinBtn'),
        resultText: document.getElementById('resultText'),
        warningMsg: document.getElementById('warningMsg'),
        syncInput: document.getElementById('syncKeyInput'),
        btnSync: document.getElementById('btnSync')
    };
    const ctx = els.canvas.getContext('2d');

    // --- ÂàùÂßãÂåñ ---
    function init() {
        // ÂÖà‰ªéÊú¨Âú∞Âä†ËΩΩ
        let stored = localStorage.getItem('decisionMaker_db_data');
        if (stored) {
            try { topics = JSON.parse(stored); } catch(e) { topics = JSON.parse(JSON.stringify(defaultTopics)); }
        } else {
            topics = JSON.parse(JSON.stringify(defaultTopics));
        }

        // Â∞ùËØïÂä†ËΩΩ‰∏äÊ¨°‰ΩøÁî®ÁöÑÂêåÊ≠•ÊöóÂè∑
        const lastSyncKey = localStorage.getItem('decisionMaker_last_sync_key');
        if (lastSyncKey) els.syncInput.value = lastSyncKey;

        // Êï∞ÊçÆÊ∏ÖÊ¥ó
        topics.forEach(t => {
            if(!t.options) t.options = ["ÈªòËÆ§ÈÄâÈ°π"];
            if(!t.id) t.id = 't' + Math.random().toString(36).substr(2, 9);
        });

        if (topics.length > 0) selectTopic(topics[0].id);
        else createNewTopic();

        renderSidebar();
        bindEvents();
    }

    function saveData() {
        localStorage.setItem('decisionMaker_db_data', JSON.stringify(topics));
        showSaveStatus();
    }

    let saveTimeout;
    function showSaveStatus() {
        els.saveStatus.classList.add('visible');
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { els.saveStatus.classList.remove('visible'); }, 1500);
    }

    // --- ‚òÅÔ∏è ‰∫ëÂêåÊ≠•Ê†∏ÂøÉÈÄªËæë ---
    async function startCloudSync() {
        if (!supabase) return alert("ËØ∑ÂÖàÂú® HTML ‰ª£Á†Å‰∏≠ÈÖçÁΩÆ Supabase URL Âíå KeyÔºÅ");
        
        const syncKey = els.syncInput.value.trim();
        if (!syncKey) return alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÂêåÊ≠•ÊöóÂè∑ÔºÅ\nÔºà‰æãÂ¶Ç‰Ω†ÁöÑÂêçÂ≠ó+Êï∞Â≠óÔºå‰∏§Âè∞ËÆæÂ§áËæìÂÖ•‰∏ÄÊ†∑ÁöÑÂç≥ÂèØÂêåÊ≠•Ôºâ");

        const btn = els.btnSync;
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥";
        btn.disabled = true;

        try {
            // 1. Êü•ËØ¢‰∫ëÁ´ØÊòØÂê¶Â≠òÂú®Ê≠§ÊöóÂè∑ÁöÑÊï∞ÊçÆ
            const { data, error } = await supabase
                .from('user_decisions')
                .select('content')
                .eq('sync_key', syncKey)
                .maybeSingle();

            if (error) throw error;

            if (data) {
                // A. ‰∫ëÁ´ØÊúâÊï∞ÊçÆ
                const userChoice = confirm(`‚òÅÔ∏è Âú®‰∫ëÁ´ØÂèëÁé∞ÊöóÂè∑ [${syncKey}] ÁöÑÊï∞ÊçÆÔºÅ\n\n„ÄêÁ°ÆÂÆö„Äë= ‰∏ãËΩΩ‰∫ëÁ´ØÊï∞ÊçÆË¶ÜÁõñÊú¨Âú∞\n„ÄêÂèñÊ∂à„Äë= Â∞ÜÊú¨Âú∞Êï∞ÊçÆ‰∏ä‰º†Ë¶ÜÁõñ‰∫ëÁ´Ø`);
                
                if (userChoice) {
                    // ‰∏ãËΩΩ
                    if (data.content && Array.isArray(data.content)) {
                        topics = data.content;
                        saveData();
                        selectTopic(topics[0].id);
                        alert("‚úÖ ÂêåÊ≠•ÊàêÂäüÔºöÂ∑≤‰∏ãËΩΩ‰∫ëÁ´ØÊï∞ÊçÆÔºÅ");
                    }
                } else {
                    // ‰∏ä‰º†Ë¶ÜÁõñ
                    await uploadToCloud(syncKey);
                }
            } else {
                // B. ‰∫ëÁ´ØÊó†Êï∞ÊçÆ -> Ëá™Âä®‰∏ä‰º†
                await uploadToCloud(syncKey);
            }

            // ËÆ∞‰ΩèÊöóÂè∑
            localStorage.setItem('decisionMaker_last_sync_key', syncKey);

        } catch (err) {
            console.error(err);
            alert("‚ùå ÂêåÊ≠•Âá∫ÈîôÔºö" + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function uploadToCloud(key) {
        // Upsert: Â≠òÂú®ÂàôÊõ¥Êñ∞Ôºå‰∏çÂ≠òÂú®ÂàôÊèíÂÖ•
        const { error } = await supabase
            .from('user_decisions')
            .upsert({ sync_key: key, content: topics }, { onConflict: 'sync_key' });
            
        if (error) throw error;
        alert("‚úÖ ÂêåÊ≠•ÊàêÂäüÔºöÊú¨Âú∞Êï∞ÊçÆÂ∑≤‰∏ä‰º†Âà∞‰∫ëÁ´ØÔºÅ\nÂÖ∂‰ªñËÆæÂ§áËæìÂÖ•Ê≠§ÊöóÂè∑Âç≥ÂèØ‰∏ãËΩΩ„ÄÇ");
    }

    // --- Â∏∏ËßÑÈÄªËæë ---
    function getTopic(id) { return topics.find(t => t.id === id); }

    function selectTopic(id) {
        const topic = getTopic(id);
        if (!topic) return;
        currentTopicId = id;
        
        els.topicTitle.value = topic.title || "";
        els.topicOptions.value = Array.isArray(topic.options) ? topic.options.join(' ') : "";
        
        els.resultText.innerText = "";
        els.resultText.classList.remove('show');
        els.warningMsg.style.display = 'none';
        
        sessionCounts = {}; 
        topic.options.forEach(opt => sessionCounts[opt] = 0);

        currentRotation = 0;
        els.canvas.style.transform = `rotate(0deg)`;

        renderSidebar();
        drawWheel();
    }

    function createNewTopic() {
        const newId = 't' + Date.now();
        const newTopic = { id: newId, title: "Êñ∞ÂÜ≥ÂÆö", options: ["ÊòØ", "Âê¶"] };
        topics.push(newTopic);
        saveData();
        selectTopic(newId);
        setTimeout(() => {
            if (window.innerWidth <= 768) {
                els.sidebar.scrollLeft = els.sidebar.scrollWidth;
            } else {
                const container = document.querySelector('.topic-list-container');
                container.scrollTop = container.scrollHeight;
            }
        }, 100);
    }

    function deleteTopic(id, event) {
        event.stopPropagation();
        if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü")) {
            topics = topics.filter(t => t.id !== id);
            if (topics.length === 0) createNewTopic();
            else if (currentTopicId === id) selectTopic(topics[0].id);
            else {
                saveData();
                renderSidebar();
            }
        }
    }

    function updateCurrentTopic() {
        if (!currentTopicId) return;
        const topic = getTopic(currentTopicId);
        if (!topic) return;

        topic.title = els.topicTitle.value;
        let rawOptions = els.topicOptions.value;
        let opts = rawOptions.split(/[,\uff0c\n\s]+/).filter(t => t.trim() !== "");
        if (opts.length === 0) opts = ["?"];
        
        if(JSON.stringify(topic.options) !== JSON.stringify(opts)) {
            sessionCounts = {};
            opts.forEach(o => sessionCounts[o] = 0);
            els.resultText.innerText = "";
            els.resultText.classList.remove('show');
            els.warningMsg.style.display = 'none';
        }

        topic.options = opts;
        saveData();
        renderSidebar(); 
        drawWheel();
    }

    // --- Ê∏≤Êüì UI ---
    function renderSidebar() {
        els.topicList.innerHTML = '';
        topics.forEach(topic => {
            const li = document.createElement('li');
            li.className = `topic-item ${topic.id === currentTopicId ? 'active' : ''}`;
            li.onclick = () => selectTopic(topic.id);
            const displayTitle = topic.title || '(Êó†Ê†áÈ¢ò)';
            li.innerHTML = `
                <span class="topic-text">${displayTitle}</span> 
                <span class="btn-delete-topic" onclick="deleteTopic('${topic.id}', event)">‚úï</span>
            `;
            els.topicList.appendChild(li);
        });
    }

    function drawWheel() {
        if (!currentTopicId) return;
        const topic = getTopic(currentTopicId);
        if (!topic) return;
        const options = topic.options;
        const len = options.length;
        const arc = 2 * Math.PI / len;
        
        const w = els.canvas.width;
        const h = els.canvas.height;
        const cx = w / 2;
        const cy = h / 2;
        const radius = w / 2 - 20;

        ctx.clearRect(0, 0, w, h);

        options.forEach((opt, i) => {
            const angle = i * arc;
            ctx.beginPath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, angle, angle + arc);
            ctx.lineTo(cx, cy);
            ctx.fill();
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 40px 'Noto Sans SC', sans-serif";
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 4;
            let text = opt;
            if (text.length > 8) text = text.substring(0, 7) + "..";
            ctx.fillText(text, radius - 40, 14);
            ctx.restore();
        });

        ctx.beginPath();
        ctx.arc(cx, cy, 50, 0, 2 * Math.PI);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.lineWidth = 10;
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.stroke();
    }

    function spin() {
        if (isSpinning) return;
        const topic = getTopic(currentTopicId);
        if (!topic || topic.options.length < 1) return;

        isSpinning = true;
        els.spinBtn.disabled = true;
        els.resultText.classList.remove('show');
        els.warningMsg.style.display = 'none';

        const randomDeg = Math.floor(Math.random() * 360);
        const totalSpin = 1800 + randomDeg; 
        currentRotation += totalSpin;
        
        els.canvas.style.transform = `rotate(-${currentRotation}deg)`;

        setTimeout(() => {
            finishSpin(currentRotation, topic.options);
        }, 4000);
    }

    function finishSpin(rotation, options) {
        isSpinning = false;
        els.spinBtn.disabled = false;
        const actualDeg = rotation % 360;
        const sliceDeg = 360 / options.length;
        let degFromStart = (360 - actualDeg + 270) % 360;
        let index = Math.floor(degFromStart / sliceDeg);
        index = index % options.length;
        const result = options[index];
        
        if (!sessionCounts[result]) sessionCounts[result] = 0;
        sessionCounts[result]++;

        els.resultText.innerText = `üéâ ${result}`;
        els.resultText.classList.add('show');
        
        if (sessionCounts[result] > 3) {
            els.warningMsg.style.display = 'inline-block';
        }
    }

    function bindEvents() {
        els.btnAddTopic.addEventListener('click', createNewTopic);
        els.topicTitle.addEventListener('input', updateCurrentTopic);
        els.topicOptions.addEventListener('input', updateCurrentTopic);
        els.spinBtn.addEventListener('click', spin);
    }

    init();

</script>
</body>
</html>
